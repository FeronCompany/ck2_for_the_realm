

namespace = ftr_tournament

# 0001-0999 Starter events
# 1001-1999 spectator on_action events
# 2001-2999 competitor on_action events

# Letter to invite vassal
ftr_tournament.0001 = {
	type = letter_event
	opening = {
		desc = ftr_tournament.0001.opening
	}
	desc = {
		desc = ftr_tournament.0001.opening_desc
		first_valid = {
			triggered_desc = {
				trigger = {
					reverse_opinion = {
						target = scope:sender
						value > 50
					}
				}
				desc = ftr_tournament.0001.host_likes_me
			}
			triggered_desc = {
				trigger = {
					reverse_opinion = {
						target = scope:sender
						value > -1
					}
				}
				desc = ftr_tournament.0001.host_gets_along_with_me
			}
			desc = ftr_tournament.0001.host_dislikes_me
		}
	}
	sender = scope:sender

	trigger = {
		is_available_for_activity_trigger = yes
		exists = scope:activity.activity_owner
		target_is_liege_or_above = scope:activity.activity_owner
		NOT = { exists = var:is_handling_tournament_invitation }
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		if = {
			limit = {
				is_available_for_activity_trigger = yes
				exists = var:is_handling_tournament_invitation
			}
			trigger_event = {
				id = ftr_tournament.0001
				days = 1
			}
		}
	}

	immediate = {
		scope:activity.activity_owner = {
			save_scope_as = sender
		}
		scope:activity.activity_province = {
			barony = {
				save_scope_as = barony
			}
		}
		set_variable = {
			name = is_handling_tournament_invitation
			value = scope:sender
			days = 20
		}
	}

	option = {
		name = ftr_tournament.0001.a
		play_music_cue = mx_cue_banquet
		scope:activity = {
			accept_invitation_for_character = prev
		}
		set_variable = {
			name = booked_for_a_party
			value = scope:sender
			days = 20
		}
		stress_impact = {
			brave = minor_stress_loss
			arrogant = minor_stress_loss
		}
		ai_chance = {
			base = 50
			opinion_modifier = {
				opinion_target = scope:sender
			}
		}
	}

	option = {
		name = ftr_tournament.0001.b
		scope:activity = {
			decline_invitation_for_character = prev
		}
		stress_impact = {
			inappetetic = minor_stress_loss
			craven = minor_stress_loss
		}
		ai_chance = {
			base = 10
		}
	}

	after = {
		remove_variable = is_handling_tournament_invitation
	}
}

#Letter to invite liege
ftr_tournament.0002 = {
	type = letter_event
	opening = {
		desc = ftr_tournament.0001.opening # reuse ftr_tournament.0001
	}
	desc = ftr_tournament.0002.desc
	sender = scope:sender

	trigger = {
		is_available_for_activity_trigger = yes
		NOT = { exists = var:is_handling_tournament_invitation }
		exists = scope:activity.activity_owner #In case the activity owner dies waiting...
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		if = {
			limit = {
				is_available_for_activity_trigger = yes
				exists = var:is_handling_tournament_invitation
			}
			trigger_event = {
				id = ftr_tournament.0002
				days = 1
			}
		}
	}

	immediate = {
		scope:activity.activity_owner = {
			save_scope_as = sender
		}
		scope:activity.activity_province = {
			barony = {
				save_scope_as = barony
			}
		}
		set_variable = {
			name = is_handling_tournament_invitation
			value = scope:sender
			days = 20
		}
	}

	option = {
		name = ftr_tournament.0002.a
		play_music_cue = mx_cue_banquet
		scope:activity = {
			accept_invitation_for_character = prev
		}
		set_variable = {
			name = booked_for_a_party
			value = scope:sender
			days = 20
		}
		stress_impact = {
			brave = minor_stress_loss
			arrogant = minor_stress_loss
		}
		ai_chance = {
			base = 100
			opinion_modifier = {
				opinion_target = scope:sender
			}
		}
	}

	option = {
		name = ftr_tournament.0002.b
		ai_chance = {
			base = 10
			modifier = {
				add = 15
				target_is_liege_or_above = scope:sender
			}
			ai_value_modifier = {
				ai_boldness = 0.2
			}
		}
		scope:activity = {
			decline_invitation_for_character = prev
		}
		stress_impact = {
			inappetetic = minor_stress_loss
			craven = minor_stress_loss
		}
	}

	after = {
		remove_variable = is_handling_tournament_invitation
	}
}

#Other relations
ftr_tournament.0003 = {
	type = letter_event
	opening = {
		desc = ftr_tournament.0001.opening
	}
	desc = ftr_tournament.0003.desc
	sender = scope:sender

	trigger = {
		is_available_for_activity_trigger = yes
		NOT = { exists = var:is_handling_tournament_invitation }
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		if = {
			limit = {
				is_available_for_activity_trigger = yes
				exists = var:is_handling_tournament_invitation
			}
			trigger_event = {
				id = ftr_tournament.0003
				days = 1
			}
		}
	}

	immediate = {
		scope:activity.activity_owner = {
			save_scope_as = sender
		}
		scope:activity.activity_province = {
			barony = {
				save_scope_as = barony
			}
		}
		set_variable = {
			name = is_handling_tournament_invitation
			value = scope:sender
			days = 20
		}
	}

	option = {
		name = ftr_tournament.0003.a
		play_music_cue = mx_cue_banquet
		scope:activity = {
			accept_invitation_for_character = prev
		}
		set_variable = {
			name = booked_for_a_party
			value = scope:sender
			days = 20
		}
		stress_impact = {
			brave = minor_stress_loss
			arrogant = minor_stress_loss
		}
		ai_chance = {
			base = 100
			opinion_modifier = {
				opinion_target = scope:sender
			}
		}
	}

	option = {
		name = ftr_tournament.0003.b
		scope:activity = {
			decline_invitation_for_character = prev
		}
		stress_impact = {
			inappetetic = minor_stress_loss
			craven = minor_stress_loss
		}
		ai_chance = {
			base = 10
			modifier = {
				add = 15
				scope:sender = {
					target_is_liege_or_above = scope:sender
				}
			}
			ai_value_modifier = {
				ai_boldness = 0.2
			}
		}
	}

	after = {
		remove_variable = is_handling_tournament_invitation
	}
}

#Tournament End
ftr_tournament.0004 = {
	type = character_event
	title = ftr_tournament.0004.t
	desc = ftr_tournament.0004.desc
	theme = hunting
	left_portrait = {
		character = scope:cavalry_champion
		animation = war_over_win
	}
	right_portrait = {
		character = scope:infantry_champion
		animation = war_over_win
	}

	immediate = {
		scope:activity = {
			every_participant = {
				if = {
					limit = {
						var:tournament_role = 1
					}
					add_to_list = cavalry_group
				}
				else_if = {
					limit = {
						var:tournament_role = 2
					}
					add_to_list = infantry_group
				}
			}
			ordered_in_list = {
				list = cavalry_group
				order_by = var:tournament_score
				max = 1
				save_scope_as = cavalry_champion
			}
			ordered_in_list = {
				list = infantry_group
				order_by = var:tournament_score
				max = 1
				save_scope_as = infantry_champion
			}
		}
	}

	option = {
		name = ftr_tournament.0004.a
		scope:activity = {
			every_participant = {
				limit = { NOT = { this = root } }
				custom = ftr_tournament.0004.a.success
				add_opinion = {
					target = root
					modifier = ftr_hosted_successful_tournament
				}
			}
		}
		scope:activity = {
			complete_activity = yes
		}
		ai_chance = {
			base = 100
		}
	}

	after = {
		scope:cavalry_champion = {
			add_character_modifier = {
				modifier = ftr_tournament_champion_modifier
				years = 5
			}
		}
		scope:infantry_champion = {
			add_character_modifier = {
				modifier = ftr_tournament_champion_modifier
				years = 5
			}
		}
	}
}

#Choose group
ftr_tournament.0005 = {
	type = character_event
	title = ftr_tournament.0005.t
	desc = ftr_tournament.0005.desc
	theme = hunting
	left_portrait = {
		character = root
	}

	immediate = {}

	option = { # Be spectator
		name = ftr_tournament.0005.a
		set_variable = {
			name = tournament_role
			value = 0
			days = 45
		}
		trigger_event = {
			on_action = tournament_spectator_events
		}
		ai_chance = {
			base = 50
			modifier = {
				add = -40
				has_trait = brave
			}
			modifier = {
				add = -10
				has_trait = arrogant
			}
			modifier = {
				add = 40
				has_trait = craven
			}
			modifier = {
				add = 40
				has_trait = shy
			}
		}
	}
	option = { # Join cavalry_group
		name = ftr_tournament.0005.b
		trigger = {
			OR = {
				is_male = yes
				AND = {
					is_male = no
					culture = {
						has_cultural_parameter = high_prowess_ignores_knight_restrictions
					}
				}
			}
		}
		set_variable = {
			name = tournament_role
			value = 1
			days = 45
		}
		set_variable = {
			name = tournament_score
			value = prowess
			days = 45
		}
		trigger_event = {
			on_action = tournament_cavalry_events
		}
		ai_chance = {
			base = 50
		}
	}
	option = { # Join infantry_group
		name = ftr_tournament.0005.c
		trigger = {
			OR = {
				is_male = yes
				AND = {
					is_male = no
					culture = {
						has_cultural_parameter = high_prowess_ignores_knight_restrictions
					}
				}
			}
		}
		set_variable = {
			name = tournament_role
			value = 2
			days = 45
		}
		set_variable = {
			name = tournament_score
			value = prowess
			days = 45
		}
		trigger_event = {
			on_action = tournament_infantry_events
		}
		ai_chance = {
			base = 50
		}
	}
}

#Tournament End for participants
ftr_tournament.0006 = {
	type = character_event
	title = ftr_tournament.0006.t
	desc = ftr_tournament.0006.desc
	theme = hunting
	left_portrait = {
		character = scope:cavalry_champion
		animation = war_over_win
	}
	right_portrait = {
		character = scope:infantry_champion
		animation = war_over_win
	}

	immediate = {}

	option = {
		name = ftr_tournament.0006.a
		ai_chance = {
			base = 100
		}
	}
}

#Tournament start, setting up worrors
ftr_tournament.0007 = {
	hidden = yes
	immediate = {
		while = {
			count = 2
			create_character = {
				gender = male
				location = root.location
				culture = root.culture
				faith = root.faith
				after_creation = {
					add_prowess_skill = 10
					set_variable = {
						name = tournament_score
						value = prowess
						days = 45
					}
					set_variable = {
						name = tournament_role
						value = 1
						days = 45
					}
					scope:activity = {
						accept_invitation_for_character = prev
					}
				}
			}
		}
		while = {
			count = 2
			create_character = {
				gender = male
				location = root.location
				culture = root.culture
				faith = root.faith
				after_creation = {
					add_prowess_skill = 10
					set_variable = {
						name = tournament_score
						value = prowess
						days = 45
					}
					set_variable = {
						name = tournament_role
						value = 2
						days = 45
					}
					scope:activity = {
						accept_invitation_for_character = prev
					}
				}
			}
		}
	}
}

# Expire
ftr_tournament.0008 = {
	type = character_event
	title = ftr_tournament.0008.t
	desc = ftr_tournament.0008.desc
	theme = hunting

	immediate = {}

	option = {
		name = ftr_tournament.0008.a
	}
}

# Host die
ftr_tournament.0009 = {
	type = character_event
	title = ftr_tournament.0009.t
	desc = ftr_tournament.0009.desc
	theme = hunting
	left_portrait = {
		character = scope:host
	}

	immediate = {}

	option = {
		name = ftr_tournament.0009.a
	}
}

#The host has been imprisoned - for host
ftr_tournament.0010 = {
	type = character_event
	title = ftr_tournament.0010.t
	desc = ftr_tournament.0010.desc
	theme = hunting
	override_icon = {
		reference = "gfx/interface/icons/event_types/type_prison.dds"
	}
	left_portrait = {
		character = scope:host
		animation = prison_dungeon
	}

	immediate = {}
	
	option = {
		name = ftr_tournament.0010.a
	}

	after = {}
}

#The host has been imprisoned - for guests
ftr_tournament.0011 = {
	type = character_event
	title = ftr_tournament.0011.t
	desc = ftr_tournament.0011.desc
	theme = hunting
	override_icon = {
		reference = "gfx/interface/icons/event_types/type_prison.dds"
	}
	left_portrait = {
		character = scope:host
		animation = prison_dungeon
	}
	
	option = {
		name = ftr_tournament.0011.a
	}
}

#The host is at war - for host
ftr_tournament.0012 = {
	type = character_event
	title = ftr_tournament.0012.t
	desc = ftr_tournament.0012.desc
	theme = hunting
	left_portrait = {
		character = scope:host
		animation = war_defender
	}

	immediate = {}
	
	option = {
		name = ftr_tournament.0012.a
	}

	after = {}
}

#The host is at war - for guests
ftr_tournament.0013 = {
	type = character_event
	title = ftr_tournament.0013.t
	desc = ftr_tournament.0013.desc
	theme = hunting
	left_portrait = {
		character = scope:host
		animation = war_defender
	}
	
	option = {
		name = ftr_tournament.0013.a
	}
}

#Nice Intermatch Show
ftr_tournament.1001 = {
	type = character_event
	title = ftr_tournament.1001.t
	desc = ftr_tournament.1001.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = happiness
	}
	
	option = {
		name = ftr_tournament.1001.a
	}
}

#Be ambitious
ftr_tournament.1002 = {
	type = character_event
	title = ftr_tournament.1002.t
	desc = ftr_tournament.1002.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = personality_bold
	}
	trigger = {
		OR = {
			has_trait = brave
			has_trait = arrogant
			has_trait = ambitious
		}
		NOT = { has_variable = has_1002 }
	}

	immediate = {
		set_variable = {	
			name = has_1002
			value = yes
			days = 50
		}
	}
	
	option = {
		name = ftr_tournament.1002.a
	}
}

#Tie
ftr_tournament.1003 = {
	type = character_event
	title = ftr_tournament.1003.t
	desc = ftr_tournament.1003.desc
	theme = hunting
	left_portrait = {
		character = root
	}

	immediate = {}
	
	option = {
		name = ftr_tournament.1003.a
	}
}

#Stands crash
ftr_tournament.1004 = {
	type = character_event
	title = ftr_tournament.1004.t
	desc = ftr_tournament.1004.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = shock
	}
	trigger = {
		NOT = { has_variable = has_1004 }
	}

	immediate = {
		set_variable = {	
			name = has_1004
			value = yes
			days = 50
		}
		scope:activity = {
			hidden_effect = {
				every_participant = {
					if = {
						limit = {
							var:tournament_role = 0
						}
						random_list = {
							70 = {
								#Nothing happen
							}
							20 = {
								add_to_list = injured_list
							}
							10 = {
								add_to_list = death_list
							}
						}
					}
				}
			}
			every_in_list = {
				list = injured_list
				send_interface_toast = {	
					title = ftr_tournament.1004.injured
					desc = ftr_tournament.1004.injured.desc
					change_trait_rank = {
						trait = wounded
						rank = 1
						max = 3
					}
				}
			}
			every_in_list = {
				list = death_list
				send_interface_toast = {
					title = ftr_tournament.1004.death
					desc = ftr_tournament.1004.death.desc
					death = {
						death_reason = death_fall
					}
				}
			}
		}
		complete_activity = yes
		scope:host = {
			trigger_event = ftr_tournament.1011
		}
	}
	
	option = {
		name = ftr_tournament.1004.a
	}
}

#wrong bet
ftr_tournament.1005 = {
	type = character_event
	title = ftr_tournament.1005.t
	desc = ftr_tournament.1005.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = rage
	}

	immediate = {}
	
	option = {
		name = ftr_tournament.1005.a
		remove_short_term_gold = {
			add = -15
		}
	}
}

#Nice worrior
ftr_tournament.1006 = {
	type = character_event
	title = ftr_tournament.1006.t
	desc = ftr_tournament.1006.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = admiration
	}
	left_portrait = {
		character = scope:nice_worrior
		animation = personality_bold
	}

	immediate = {
		create_character = {
			gender = male
			location = root.location
			culture = root.culture
			faith = root.faith
			after_creation = {
				add_prowess_skill = 15
			}
			save_scope_as = nice_worrior
		}
	}
	
	option = {
		name = ftr_tournament.1006.a
		pay_short_term_gold = {
			gold = 50
			target = scope:nice_worrior
		}
		recruit_courtier = scope:nice_worrior
		scope:nice_worrior = {
			add_opinion = {
				target = root
				modifier = gift_opinion
				opinion = send_gift_opinion
			}
		}
	}
	option = {
		name = ftr_tournament.1006.b
	}
}

#quarrel
ftr_tournament.1007 = {
	type = character_event
	title = ftr_tournament.1007.t
	desc = ftr_tournament.1007.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = rage
	}
	left_portrait = {
		character = scope:quarrel_target
		animation = rage
	}

	immediate = {
		scope:activity = {
			every_participant = {
				limit = {
					NOT = { this = root }
					var:tournament_role = 0
				}
				add_to_temporary_list = spectator_list
			}
		}
		random_in_list = {
			list = spectator_list
			save_scope_as = quarrel_target
		}
	}
	
	option = {
		name = ftr_tournament.1007.a
		add_opinion = {
			target = quarrel_target
			modifier = rival_insult_opinion
		}
		scope:quarrel_target = {
			add_opinion = {
				target = root
				modifier = rival_insult_opinion
			}
			send_interface_toast = {
				title = ftr_tournament.1007.a.quarrel
				desc = ftr_tournament.1007.a.quarrel.desc
				left_icon = root
				right_icon = scope:quarrel_target
			}
		}
	}
	option = {
		name = ftr_tournament.1007.b
		trigger = {
			diplomacy >= 10
		}
	}
	option = {
		name = ftr_tournament.1007.c
		add_prestige = -100
	}
}

#horse charge into crowds
ftr_tournament.1008 = {
	type = character_event
	title = ftr_tournament.1008.t
	desc = ftr_tournament.1008.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = shock
	}
	trigger = {
		NOT = { has_variable = has_1008 }
	}

	immediate = {
		set_variable = {	
			name = has_1008
			value = yes
			days = 50
		}
		scope:activity = {
			every_participant = {
				limit = {
					var:tournament_role = 0
				}
				add_to_temporary_list = spectator_list
			}
			random_in_list = {
				list = spectator_list
				random_list = {
					90 = {
						send_interface_toast = {	
							title = ftr_tournament.1008.injured
							desc = ftr_tournament.1008.injured.desc
							change_trait_rank = {
								trait = wounded
								rank = 1
								max = 3
							}
						}
					}
					10 = {
						send_interface_toast = {
							title = ftr_tournament.1008.death
							desc = ftr_tournament.1008.death.desc
							death = {
								death_reason = death_horse_riding_accident
							}
						}
					}
				}
			}
		}
	}
	
	option = {
		name = ftr_tournament.1008.a
	}
}

#be friends with other apectator
ftr_tournament.1009 = {
	type = character_event
	title = ftr_tournament.1009.t
	desc = ftr_tournament.1009.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = happiness
	}
	left_portrait = {
		character = scope:new_friend
		animation = happiness
	}

	immediate = {
		scope:activity = {
			every_participant = {
				limit = {
					NOT = { this = root }
					NOT = { has_relation_friend = root }
					var:tournament_role = 0
				}
				add_to_temporary_list = spectator_list
			}
		}
		random_in_list = {
			list = spectator_list
			save_scope_as = new_friend
		}
	}
	
	option = {
		name = ftr_tournament.1009.a
		set_relation_friend = {
			reason = friend_nice_talk_during_tournament
			target = scope:new_friend
		}
	}
}

#rejoice with competitors
ftr_tournament.1010 = {
	type = character_event
	title = ftr_tournament.1010.t
	desc = ftr_tournament.1010.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = happiness
	}

	immediate = {}
	
	option = {
		name = ftr_tournament.1010.a
	}
}

#Stands crash for host
ftr_tournament.1011 = {
	type = character_event
	title = ftr_tournament.1011.t
	desc = ftr_tournament.1011.desc
	theme = hunting
	left_portrait = {
		character = root
		animation = shock
	}

	immediate = {}
	
	option = {
		name = ftr_tournament.1011.a
	}
}
